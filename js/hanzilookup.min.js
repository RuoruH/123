var HanziLookup=HanziLookup||{};HanziLookup.AnalyzedCharacter=(function(rawStrokes){var MIN_SEGMENT_LENGTH=12.5;var MAX_LOCAL_LENGTH_RATIO=1.1;var MAX_RUNNING_LENGTH_RATIO=1.09;var _top=Number.MAX_SAFE_INTEGER;var _bottom=Number.MIN_SAFE_INTEGER;var _left=Number.MAX_SAFE_INTEGER;var _right=Number.MIN_SAFE_INTEGER;var _analyzedStrokes=[];var _subStrokeCount=0;getBoundingRect(rawStrokes);buildAnalyzedStrokes(rawStrokes);this.top=_top<=256?_top:0;this.bottom=_bottom>=0?_bottom:256;this.left=_left<=256?_left:0;this.right=_right>=0?_right:256;this.analyzedStrokes=_analyzedStrokes;this.subStrokeCount=_subStrokeCount;function getBoundingRect(rawStrokes){for(var i=0;i!=rawStrokes.length;++i){for(var j=0;j!=rawStrokes[i].length;++j){var pt=rawStrokes[i][j];if(pt[0]<_left){_left=pt[0]}if(pt[0]>_right){_right=pt[0]}if(pt[1]<_top){_top=pt[1]}if(pt[1]>_bottom){_bottom=pt[1]}}}}function dist(a,b){var dx=a[0]-b[0];var dy=a[1]-b[1];return Math.sqrt(dx*dx+dy*dy)}function normDist(a,b){var width=_right-_left;var height=_bottom-_top;var dimensionSquared=width>height?width*width:height*height;var normalizer=Math.sqrt(dimensionSquared+dimensionSquared);var distanceNormalized=dist(a,b)/normalizer;return Math.min(distanceNormalized,1)}function dir(a,b){var dx=a[0]-b[0];var dy=a[1]-b[1];var dir=Math.atan2(dy,dx);return Math.PI-dir}function getPivotIndexes(points){var markers=[];for(var i=0;i!=points.length;++i){markers.push(false)}var prevPtIx=0;var firstPtIx=0;var pivotPtIx=1;markers[0]=true;var localLength=dist(points[firstPtIx],points[pivotPtIx]);var runningLength=localLength;for(var i=2;i<points.length;++i){var nextPoint=points[i];var pivotLength=dist(points[pivotPtIx],nextPoint);localLength+=pivotLength;runningLength+=pivotLength;var distFromPrevious=dist(points[prevPtIx],nextPoint);var distFromFirst=dist(points[firstPtIx],nextPoint);if(localLength>MAX_LOCAL_LENGTH_RATIO*distFromPrevious||runningLength>MAX_RUNNING_LENGTH_RATIO*distFromFirst){if(markers[prevPtIx]&&dist(points[prevPtIx],points[pivotPtIx])<MIN_SEGMENT_LENGTH){markers[prevPtIx]=false}markers[pivotPtIx]=true;runningLength=pivotLength;firstPtIx=pivotPtIx}localLength=pivotLength;prevPtIx=pivotPtIx;pivotPtIx=i}markers[pivotPtIx]=true;if(markers[prevPtIx]&&dist(points[prevPtIx],points[pivotPtIx])<MIN_SEGMENT_LENGTH&&prevPtIx!=0){markers[prevPtIx]=false}var res=[];for(var i=0;i!=markers.length;++i){if(markers[i]){res.push(i)}}return res}function getNormCenter(a,b){var x=(a[0]+b[0])/2;var y=(a[1]+b[1])/2;var side;if(_right-_left>_bottom-_top){side=_right-_left;var height=_bottom-_top;x=x-_left;y=y-_top+(side-height)/2}else{side=_bottom-_top;var width=_right-_left;x=x-_left+(side-width)/2;y=y-_top}return[x/side,y/side]}function buildSubStrokes(points,pivotIndexes){var res=[];var prevIx=0;for(var i=0;i!=pivotIndexes.length;++i){var ix=pivotIndexes[i];if(ix==prevIx){continue}var direction=dir(points[prevIx],points[ix]);direction=Math.round(direction*256/Math.PI/2);if(direction==256){direction=0}var normLength=normDist(points[prevIx],points[ix]);normLength=Math.round(normLength*255);var center=getNormCenter(points[prevIx],points[ix]);center[0]=Math.round(center[0]*15);center[1]=Math.round(center[1]*15);res.push(new HanziLookup.SubStroke(direction,normLength,center[0],center[1]));prevIx=ix}return res}function buildAnalyzedStrokes(rawStrokes){for(var i=0;i!=rawStrokes.length;++i){var pivotIndexes=getPivotIndexes(rawStrokes[i]);var subStrokes=buildSubStrokes(rawStrokes[i],pivotIndexes);_subStrokeCount+=subStrokes.length;_analyzedStrokes.push(new HanziLookup.AnalyzedStroke(rawStrokes[i],pivotIndexes,subStrokes))}}});var HanziLookup=HanziLookup||{};HanziLookup.AnalyzedStroke=(function(points,pivotIndexes,subStrokes){this.points=points;this.pivotIndexes=pivotIndexes;this.subStrokes=subStrokes});var HanziLookup=HanziLookup||{};HanziLookup.CharacterMatch=(function(character,score){this.character=character;this.score=score});var HanziLookup=HanziLookup||{};HanziLookup.CubicCurve2D=(function(x1,y1,ctrlx1,ctrly1,ctrlx2,ctrly2,x2,y2){var _x1=x1;var _y1=y1;var _ctrlX1=ctrlx1;var _ctrlY1=ctrly1;var _ctrlX2=ctrlx2;var _ctrlY2=ctrly2;var _x2=x2;var _y2=y2;function getCubicAx(){return _x2-_x1-getCubicBx()-getCubicCx()}function getCubicAy(){return _y2-_y1-getCubicBy()-getCubicCy()}function getCubicBx(){return 3*(_ctrlX2-_ctrlX1)-getCubicCx()}function getCubicBy(){return 3*(_ctrlY2-_ctrlY1)-getCubicCy()}function getCubicCx(){return 3*(_ctrlX1-_x1)}function getCubicCy(){return 3*(_ctrlY1-_y1)}function doSolveForX(x){var solutions=[];var a=getCubicAx();var b=getCubicBx();var c=getCubicCx();var d=_x1-x;var f=((3*c/a)-(b*b/(a*a)))/3;var g=((2*b*b*b/(a*a*a))-(9*b*c/(a*a))+(27*d/a))/27;var h=(g*g/4)+(f*f*f/27);if(h>0){var u=0-g;var r=(u/2)+(Math.pow(h,0.5));var s6=(Math.pow(r,0.3333333333333333));var s8=s6;var t8=(u/2)-(Math.pow(h,0.5));var v7=(Math.pow((0-t8),0.3333333333333333));var v8=(v7);var x3=(s8-v8)-(b/(3*a));solutions.push(x3)}else{if(f==0&&g==0&&h==0){solutions.push(-Math.pow(d/a,1/3))}else{var i=Math.sqrt((g*g/4)-h);
var j=Math.pow(i,1/3);var k=Math.acos(-g/(2*i));var l=j*-1;var m=Math.cos(k/3);var n=Math.sqrt(3)*Math.sin(k/3);var p=(b/(3*a))*-1;solutions.push(2*j*Math.cos(k/3)-(b/(3*a)));solutions.push(l*(m+n)+p);solutions.push(l*(m-n)+p)}}return solutions}return{x1:function(){return _x1},x2:function(){return _x2},getYOnCurve:function(t){var ay=getCubicAy();var by=getCubicBy();var cy=getCubicCy();var tSquared=t*t;var tCubed=t*tSquared;var y=(ay*tCubed)+(by*tSquared)+(cy*t)+_y1;return y},solveForX:function(x){return doSolveForX(x)},getFirstSolutionForX:function(x){var solutions=doSolveForX(x);for(var i=0;i!=solutions.length;++i){var d=solutions[i];if(d>=-1e-8&&d<=1.00000001){if(d>=0&&d<=1){return d}if(d<0){return 0}return 1}}return NaN}}});var HanziLookup=HanziLookup||{};HanziLookup.decodeCompact=(function(base64){var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var lookup=new Uint8Array(256);for(var i=0;i<chars.length;i++){lookup[chars.charCodeAt(i)]=i}var bufferLength=base64.length*0.75,len=base64.length,i,p=0,encoded1,encoded2,encoded3,encoded4;if(base64[base64.length-1]==="="){bufferLength--;if(base64[base64.length-2]==="="){bufferLength--}}var arraybuffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(arraybuffer);for(i=0;i<len;i+=4){encoded1=lookup[base64.charCodeAt(i)];encoded2=lookup[base64.charCodeAt(i+1)];encoded3=lookup[base64.charCodeAt(i+2)];encoded4=lookup[base64.charCodeAt(i+3)];bytes[p++]=(encoded1<<2)|(encoded2>>4);bytes[p++]=((encoded2&15)<<4)|(encoded3>>2);bytes[p++]=((encoded3&3)<<6)|(encoded4&63)}return bytes});var HanziLookup=HanziLookup||{};HanziLookup.DrawingBoard=(function(elmHost,strokeFinished){var _elmHost=elmHost;var _strokeFinised=strokeFinished;var _canvas;var _ctx;var strokeWidth=5;var clicking=false;var lastTouchX=-1;var lastTouchY=-1;var tstamp;var lastPt;var _rawStrokes=[];var _currentStroke=null;var _overlay=null;var _showSubstrokes=false;var _showBoundary=false;var _showControlMedians=false;_canvas=$('<canvas class="stroke-input-canvas" width="256" height="256"></canvas>');_elmHost.append(_canvas);_ctx=_canvas[0].getContext("2d");_canvas.mousemove(function(e){if(!clicking){return}var x=e.pageX-$(this).offset().left;var y=e.pageY-$(this).offset().top;dragClick(x,y)});_canvas.mousedown(function(e){var x=e.pageX-$(this).offset().left;var y=e.pageY-$(this).offset().top;startClick(x,y)}).mouseup(function(e){var x=e.pageX-$(this).offset().left;var y=e.pageY-$(this).offset().top;endClick(x,y)});_canvas.bind("touchmove",function(e){if(!clicking){return}e.preventDefault();var x=e.originalEvent.touches[0].pageX-$(this).offset().left;lastTouchX=x;var y=e.originalEvent.touches[0].pageY-$(this).offset().top;lastTouchY=y;dragClick(x,y)});_canvas.bind("touchstart",function(e){e.preventDefault();document.activeElement.blur();var x=e.originalEvent.touches[0].pageX-$(this).offset().left;var y=e.originalEvent.touches[0].pageY-$(this).offset().top;startClick(x,y)}).bind("touchend",function(e){e.preventDefault();document.activeElement.blur();endClick(lastTouchX,lastTouchY);lastTouchX=lastTouchY=-1});drawClearCanvas();function drawClearCanvas(){_ctx.clearRect(0,0,_ctx.canvas.width,_ctx.canvas.height);_ctx.setLineDash([1,1]);_ctx.lineWidth=0.5;_ctx.strokeStyle="grey";_ctx.beginPath();_ctx.moveTo(0,0);_ctx.lineTo(_ctx.canvas.width,0);_ctx.lineTo(_ctx.canvas.width,_ctx.canvas.height);_ctx.lineTo(0,_ctx.canvas.height);_ctx.lineTo(0,0);_ctx.stroke();_ctx.beginPath();_ctx.moveTo(0,0);_ctx.lineTo(_ctx.canvas.width,_ctx.canvas.height);_ctx.stroke();_ctx.beginPath();_ctx.moveTo(_ctx.canvas.width,0);_ctx.lineTo(0,_ctx.canvas.height);_ctx.stroke();_ctx.beginPath();_ctx.moveTo(_ctx.canvas.width/2,0);_ctx.lineTo(_ctx.canvas.width/2,_ctx.canvas.height);_ctx.stroke();_ctx.beginPath();_ctx.moveTo(0,_ctx.canvas.height/2);_ctx.lineTo(_ctx.canvas.width,_ctx.canvas.height/2);_ctx.stroke()}function startClick(x,y){clicking=true;_currentStroke=[];lastPt=[x,y];_currentStroke.push(lastPt);_ctx.strokeStyle="grey";_ctx.setLineDash([]);_ctx.lineWidth=strokeWidth;_ctx.beginPath();_ctx.moveTo(x,y);tstamp=new Date()}function dragClick(x,y){if((new Date().getTime()-tstamp)<50){return}tstamp=new Date();var pt=[x,y];if((pt[0]==lastPt[0])&&(pt[1]==lastPt[1])){return}_currentStroke.push(pt);lastPt=pt;_ctx.lineTo(x,y);_ctx.stroke()}function endClick(x,y){clicking=false;if(x==-1){return}_ctx.lineTo(x,y);_ctx.stroke();_currentStroke.push([x,y]);_rawStrokes.push(_currentStroke);_currentStroke=[];if(_strokeFinised){_strokeFinised()}}function redrawInput(){for(var i1 in _rawStrokes){_ctx.strokeStyle="grey";_ctx.setLineDash([]);_ctx.lineWidth=strokeWidth;_ctx.beginPath();_ctx.moveTo(_rawStrokes[i1][0][0],_rawStrokes[i1][0][1]);var len=_rawStrokes[i1].length;for(var i2=0;i2<len-1;i2++){_ctx.lineTo(_rawStrokes[i1][i2][0],_rawStrokes[i1][i2][1]);_ctx.stroke()}_ctx.lineTo(_rawStrokes[i1][len-1][0],_rawStrokes[i1][len-1][1]);_ctx.stroke()}if(!_overlay){return}if(_showBoundary){_ctx.strokeStyle="blue";_ctx.setLineDash([1,1]);
_ctx.lineWidth=0.5;_ctx.beginPath();_ctx.moveTo(_overlay.left,_overlay.top);_ctx.lineTo(_overlay.right,_overlay.top);_ctx.stroke();_ctx.lineTo(_overlay.right,_overlay.bottom);_ctx.stroke();_ctx.lineTo(_overlay.left,_overlay.bottom);_ctx.stroke();_ctx.lineTo(_overlay.left,_overlay.top);_ctx.stroke()}if(_showSubstrokes){for(var six=0;six!=_overlay.xStrokes.length;++six){var xstroke=_overlay.xStrokes[six];_ctx.strokeStyle="red";_ctx.setLineDash([]);_ctx.lineWidth=1;_ctx.beginPath();_ctx.moveTo(xstroke[0][0],xstroke[0][1]);_ctx.arc(xstroke[0][0],xstroke[0][1],3,0,2*Math.PI,true);_ctx.fillStyle="red";_ctx.fill();for(var i=1;i<xstroke.length;++i){_ctx.lineTo(xstroke[i][0],xstroke[i][1]);_ctx.stroke();_ctx.beginPath();_ctx.arc(xstroke[i][0],xstroke[i][1],3,0,2*Math.PI,true);_ctx.fillStyle="red";_ctx.fill()}}}if(_showControlMedians&&_overlay.yStrokes){for(var six=0;six!=_overlay.yStrokes.length;++six){var ystroke=_overlay.yStrokes[six];_ctx.strokeStyle="#e6cee6";_ctx.setLineDash([]);_ctx.lineWidth=strokeWidth;_ctx.beginPath();_ctx.moveTo(ystroke[0][0],ystroke[0][1]);for(var i=1;i<ystroke.length;++i){_ctx.lineTo(ystroke[i][0],ystroke[i][1]);_ctx.stroke()}}}if(_overlay.zStrokes){for(var six=0;six!=_overlay.zStrokes.length;++six){var xstroke=_overlay.zStrokes[six];_ctx.strokeStyle="green";_ctx.setLineDash([]);_ctx.lineWidth=1;_ctx.beginPath();_ctx.moveTo(xstroke[0][0],xstroke[0][1]);_ctx.arc(xstroke[0][0],xstroke[0][1],3,0,2*Math.PI,true);_ctx.fillStyle="green";_ctx.fill();for(var i=1;i<xstroke.length;++i){_ctx.lineTo(xstroke[i][0],xstroke[i][1]);_ctx.stroke();_ctx.beginPath();_ctx.arc(xstroke[i][0],xstroke[i][1],3,0,2*Math.PI,true);_ctx.fillStyle="green";_ctx.fill()}}}}return{clearCanvas:function(){_rawStrokes.length=0},undoStroke:function(){if(_rawStrokes.length==0){return}_rawStrokes.length=_rawStrokes.length-1},cloneStrokes:function(){var res=[];for(var i=0;i!=_rawStrokes.length;++i){var stroke=[];for(var j=0;j!=_rawStrokes[i].length;++j){stroke.push([_rawStrokes[i][j][0],_rawStrokes[i][j][1]])}res.push(stroke)}return res},redraw:function(){drawClearCanvas();redrawInput()},enrich:function(overlay,showSubstrokes,showBoundary,showControlMedians){_overlay=overlay;_showBoundary=showBoundary;_showSubstrokes=showSubstrokes;_showControlMedians=showControlMedians;drawClearCanvas();redrawInput()}}});var HanziLookup=HanziLookup||{};HanziLookup.data={};HanziLookup.init=(function(dataName,url,ready){var xhr=new XMLHttpRequest();xhr.open("GET",url,true);xhr.onreadystatechange=function(){if(this.readyState!==4){return}if(this.status===200){dataReceived(dataName,xhr.responseText);ready(true)}else{ready(false)}};xhr.send();function dataReceived(dataName,responseText){HanziLookup.data[dataName]=JSON.parse(responseText);HanziLookup.data[dataName].substrokes=HanziLookup.decodeCompact(HanziLookup.data[dataName].substrokes)}});var HanziLookup=HanziLookup||{};HanziLookup.MatchCollector=(function(limit){var _count=0;var _matches=[];for(var i=0;i!=limit;++i){_matches.push(null)}function findSlot(score){var ix;for(ix=0;ix<_count;++ix){if(_matches[ix].score<score){return ix}}return ix}function removeExistingLower(match){var ix=-1;for(var i=0;i!=_count;++i){if(_matches[i].character==match.character){ix=i;break}}if(ix==-1){return false}if(match.score<=_matches[ix].score){return true}for(var i=ix;i<_matches.length-1;++i){_matches[i]=_matches[i+1]}--_count;return false}function doFileMatch(match){if(_count==_matches.length&&match.score<=_matches[_matches.length-1].score){return}if(removeExistingLower(match)){return}var pos=findSlot(match.score);for(var i=_matches.length-1;i>pos;--i){_matches[i]=_matches[i-1]}_matches[pos]=match;if(_count<_matches.length){++_count}}function doGetMatches(){return _matches.slice(0,_count)}return{fileMatch:function(match){doFileMatch(match)},getMatches:function(){return doGetMatches()}}});var HanziLookup=HanziLookup||{};HanziLookup.MAX_CHARACTER_STROKE_COUNT=48;HanziLookup.MAX_CHARACTER_SUB_STROKE_COUNT=64;HanziLookup.DEFAULT_LOOSENESS=0.15;HanziLookup.AVG_SUBSTROKE_LENGTH=0.33;HanziLookup.SKIP_PENALTY_MULTIPLIER=1.75;HanziLookup.CORRECT_NUM_STROKES_BONUS=0.1;HanziLookup.CORRECT_NUM_STROKES_CAP=10;HanziLookup.Matcher=(function(dataName,looseness){var _looseness=looseness||HanziLookup.DEFAULT_LOOSENESS;var _repo=HanziLookup.data[dataName].chars;var _sbin=HanziLookup.data[dataName].substrokes;var _scoreMatrix=buildScoreMatrix();var _charsChecked;var _subStrokesCompared;var DIRECTION_SCORE_TABLE;var LENGTH_SCORE_TABLE;var POS_SCORE_TABLE;initScoreTables();function doMatch(inputChar,limit,ready){_charsChecked=0;_subStrokesCompared=0;var matchCollector=new HanziLookup.MatchCollector(limit);if(inputChar.analyzedStrokes.length==0){return matchCollector.getMatches()}var inputSubStrokes=[];for(var i=0;i!=inputChar.analyzedStrokes.length;++i){var stroke=inputChar.analyzedStrokes[i];for(var j=0;j!=stroke.subStrokes.length;++j){inputSubStrokes.push(stroke.subStrokes[j])}}var strokeCount=inputChar.analyzedStrokes.length;var subStrokeCount=inputChar.subStrokeCount;
var strokeRange=getStrokesRange(strokeCount);var minimumStrokes=Math.max(strokeCount-strokeRange,1);var maximumStrokes=Math.min(strokeCount+strokeRange,HanziLookup.MAX_CHARACTER_STROKE_COUNT);var subStrokesRange=getSubStrokesRange(subStrokeCount)+2;var minSubStrokes=Math.max(subStrokeCount-subStrokesRange,1);var maxSubStrokes=Math.min(subStrokeCount+subStrokesRange,HanziLookup.MAX_CHARACTER_SUB_STROKE_COUNT);for(var cix=0;cix!=_repo.length;++cix){var repoChar=_repo[cix];var cmpStrokeCount=repoChar[1];var cmpSubStrokes=repoChar[2];if(cmpStrokeCount<minimumStrokes||cmpStrokeCount>maximumStrokes){continue}if(cmpSubStrokes.length<minSubStrokes||cmpSubStrokes.length>maxSubStrokes){continue}var match=matchOne(strokeCount,inputSubStrokes,subStrokesRange,repoChar);matchCollector.fileMatch(match)}ready(matchCollector.getMatches())}function getStrokesRange(strokeCount){if(_looseness==0){return 0}if(_looseness==1){return HanziLookup.MAX_CHARACTER_STROKE_COUNT}var ctrl1X=0.3;var ctrl1Y=strokeCount*0.35;var ctrl2X=0.5;var ctrl2Y=strokeCount;var curve=new HanziLookup.CubicCurve2D(0,0,ctrl1X,ctrl1Y,ctrl2X,ctrl2Y,1,HanziLookup.MAX_CHARACTER_STROKE_COUNT);var t=curve.getFirstSolutionForX(_looseness);return Math.round(curve.getYOnCurve(t))}function getSubStrokesRange(subStrokeCount){if(_looseness==1){return HanziLookup.MAX_CHARACTER_SUB_STROKE_COUNT}var y0=subStrokeCount*0.3;var ctrl1X=0.4;var ctrl1Y=2*y0;var ctrl2X=0.75;var ctrl2Y=2.5*ctrl1Y;var curve=new HanziLookup.CubicCurve2D(0,y0,ctrl1X,ctrl1Y,ctrl2X,ctrl2Y,1,HanziLookup.MAX_CHARACTER_SUB_STROKE_COUNT);var t=curve.getFirstSolutionForX(_looseness);return Math.round(curve.getYOnCurve(t))}function buildScoreMatrix(){var dim=HanziLookup.MAX_CHARACTER_SUB_STROKE_COUNT+1;var res=[];for(var i=0;i<dim;i++){res.push([]);for(var j=0;j<dim;j++){res[i].push(0)}}for(var i=0;i<dim;i++){var penalty=-HanziLookup.AVG_SUBSTROKE_LENGTH*HanziLookup.SKIP_PENALTY_MULTIPLIER*i;res[i][0]=penalty;res[0][i]=penalty}return res}function matchOne(inputStrokeCount,inputSubStrokes,subStrokesRange,repoChar){++_charsChecked;var score=computeMatchScore(inputStrokeCount,inputSubStrokes,subStrokesRange,repoChar);if(inputStrokeCount==repoChar[1]&&inputStrokeCount<HanziLookup.CORRECT_NUM_STROKES_CAP){var bonus=HanziLookup.CORRECT_NUM_STROKES_BONUS*Math.max(HanziLookup.CORRECT_NUM_STROKES_CAP-inputStrokeCount,0)/HanziLookup.CORRECT_NUM_STROKES_CAP;score+=bonus*score}return new HanziLookup.CharacterMatch(repoChar[0],score)}function computeMatchScore(strokeCount,inputSubStrokes,subStrokesRange,repoChar){for(var x=0;x<inputSubStrokes.length;x++){var inputDirection=inputSubStrokes[x].direction;var inputLength=inputSubStrokes[x].length;var inputCenter=[inputSubStrokes[x].centerX,inputSubStrokes[x].centerY];for(var y=0;y<repoChar[2];y++){var newScore=Number.NEGATIVE_INFINITY;if(Math.abs(x-y)<=subStrokesRange){var compareDirection=_sbin[repoChar[3]+y*3];var compareLength=_sbin[repoChar[3]+y*3+1];var compareCenter=null;var bCenter=_sbin[repoChar[3]+y*3+2];if(bCenter>0){compareCenter=[(bCenter&240)>>>4,bCenter&15]}var skip1Score=_scoreMatrix[x][y+1]-(inputLength/256*HanziLookup.SKIP_PENALTY_MULTIPLIER);var skip2Score=_scoreMatrix[x+1][y]-(compareLength/256*HanziLookup.SKIP_PENALTY_MULTIPLIER);var skipScore=Math.max(skip1Score,skip2Score);var matchScore=computeSubStrokeScore(inputDirection,inputLength,compareDirection,compareLength,inputCenter,compareCenter);var previousScore=_scoreMatrix[x][y];newScore=Math.max(previousScore+matchScore,skipScore)}_scoreMatrix[x+1][y+1]=newScore}}return _scoreMatrix[inputSubStrokes.length][repoChar[2]]}function computeSubStrokeScore(inputDir,inputLen,repoDir,repoLen,inputCenter,repoCenter){++_subStrokesCompared;var directionScore=getDirectionScore(inputDir,repoDir,inputLen);var lengthScore=getLengthScore(inputLen,repoLen);var score=lengthScore*directionScore;if(repoCenter){var dx=inputCenter[0]-repoCenter[0];var dy=inputCenter[1]-repoCenter[1];var closeness=POS_SCORE_TABLE[dx*dx+dy*dy];if(score>0){score*=closeness}else{score/=closeness}}return score}function initScoreTables(){var dirCurve=new HanziLookup.CubicCurve2D(0,1,0.5,1,0.25,-2,1,1);DIRECTION_SCORE_TABLE=initCubicCurveScoreTable(dirCurve,256);var lenCurve=new HanziLookup.CubicCurve2D(0,0,0.25,1,0.75,1,1,1);LENGTH_SCORE_TABLE=initCubicCurveScoreTable(lenCurve,129);POS_SCORE_TABLE=[];for(var i=0;i<=450;++i){POS_SCORE_TABLE.push(1-Math.sqrt(i)/22)}}function initCubicCurveScoreTable(curve,numSamples){var x1=curve.x1();var x2=curve.x2();var range=x2-x1;var x=x1;var xInc=range/numSamples;var scoreTable=[];for(var i=0;i<numSamples;i++){var t=curve.getFirstSolutionForX(Math.min(x,x2));scoreTable.push(curve.getYOnCurve(t));x+=xInc}return scoreTable}function getDirectionScore(direction1,direction2,inputLength){var theta=Math.abs(direction1-direction2);var directionScore=DIRECTION_SCORE_TABLE[theta];if(inputLength<64){var shortLengthBonusMax=Math.min(1,1-directionScore);var shortLengthBonus=shortLengthBonusMax*(1-(inputLength/64));directionScore+=shortLengthBonus
}return directionScore}function getLengthScore(length1,length2){var ratio;if(length1>length2){ratio=Math.round((length2<<7)/length1)}else{ratio=Math.round((length1<<7)/length2)}return LENGTH_SCORE_TABLE[ratio]}return{match:function(analyzedChar,limit,ready){doMatch(analyzedChar,limit,ready)},getCounters:function(){return{chars:_charsChecked,subStrokes:_subStrokesCompared}}}});var HanziLookup=HanziLookup||{};HanziLookup.StrokeInputOverlay=(function(top,right,bottom,left,xStrokes,yStrokes,zStrokes){this.top=top;this.right=right;this.bottom=bottom;this.left=left;this.xStrokes=xStrokes;this.yStrokes=yStrokes;this.zStrokes=zStrokes});var HanziLookup=HanziLookup||{};HanziLookup.SubStroke=(function(direction,length,centerX,centerY){this.direction=direction;this.length=length;this.centerX=centerX;this.centerY=centerY});